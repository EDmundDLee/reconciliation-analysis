/*!
 * jQuery casasypage Plugin
 * version: 1.0 (25-08-2016)
 * author: 陈雄
 * wcm下移动版的翻页插件，替代页码，只有加载更多的按钮
 */
;(function($) {
    $.fn.extend({
        casasypage: function (options) {
            options = $.extend(true, {
                type: "json",//异步加载翻页的文件类型，json或html
                start_html: "",//type为html时必填，解析翻页的开始标签位置
                end_html: "",//type为html时必填，解析翻页的结束标签位置
                chnl_url: "",//当前栏目的外网发布路径，截至到最后一级目录，形如http://10.0.3.151/preview/m_cas/include/cs/
                pub_filename: "index",//配置的json模板的发布文件名
                temp_ext: "json",//配置的json模板的文件扩展名
                temp_id: "",//配置的json模板的模板id,type为html时不需要填
                $con_obj: "",//需要加载的内容的jquery对象
                page_param: "data-page",//加载更多按钮，保存当前页码的属性名
                pagecount_param: "data-pagecount",//加载更多按钮，保存总页数的属性名
                no_con_tip: "没有更多"//没有内容时，加载更多按钮显示的内容
            }, options);
            var _type = options.type;
            var _start_html = options.start_html;
            var _end_html = options.end_html;
            if(_type == "html"){
                //type为html时，start_html和end_html必填，通过这两个字符串解析翻页内容
                if(_start_html == "" || _end_html == ""){
                    return $(this);
                }
            }
            var _chnl_url = options.chnl_url;
            if(_chnl_url == ""){
                return $(this);
            }
            var _pub_filename = options.pub_filename;
            var _temp_ext = "." + options.temp_ext;
            var _temp_id = options.temp_id;
            var pre_url = _chnl_url + _pub_filename + "_" + _temp_id;//json文件的路径前缀
            var $_con_obj = options.$con_obj;
            var _no_con_tip = options.no_con_tip;
            var _con_tip = $(this).html();
            //当前页码，没有默认为0
            var page = Number($(this).attr(options.page_param));
            if(isNaN(page) || page < 0){
                $(this).attr(options.page_param, "0");
            }
            //总页数，一定要有值
            var pagecount = Number($(this).attr(options.pagecount_param));
            if(isNaN(pagecount) || pagecount <= 1){
                //总页数不合法,或只有一页
                $(this).html(_no_con_tip);
                return $(this);
            }else{
                if((page+1) >= pagecount){
                    $(this).html(_no_con_tip);
                    return $(this);
                }else{
                    //初始化加载更多按钮，增加几分之几的按钮
                    $(this).html(_con_tip + "(" + (page+1) + "/" + pagecount + ")");
                }
            }

            $(this).on("click", function(){
                page = Number($(this).attr(options.page_param)) + 1;
                pagecount = Number($(this).attr(options.pagecount_param));
                if(page < pagecount){
                    if(_type == "json"){
                        $.getJSON(pre_url + "_" + page + _temp_ext, function(result){
                            if(result.data != null){
                                $_con_obj.append(result.data);
                            }
                        });
                    }else if(_type == "html"){
                        $.ajax({
                            type : "get",
                            url : _chnl_url + _pub_filename + "_" + page + ".html",
                            dataType : "html",
                            success : function(data) {
                                var _index = data.indexOf(_start_html);
                                if(_index != -1){
                                    data = data.substring(_index + _start_html.length);
                                }
                                _index = data.indexOf(_end_html);
                                if(_index != -1){
                                    data = data.substring(0, _index);
                                }
                                $_con_obj.append(data);
                            }
                        });
                    }
                    $(this).attr(options.page_param, page);
                    if((page + 1) >= pagecount){
                        $(this).html(_no_con_tip);
                    }else{
                        $(this).html(_con_tip + "(" + (page+1) + "/" + pagecount + ")");
                    }
                }else{
                    $(this).html(_no_con_tip);
                }
            });
            return $(this);
        }
    });
})(jQuery);